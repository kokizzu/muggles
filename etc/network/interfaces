## This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

# The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface
allow-hotplug eth0 eth1 eth2
#iface eth0 inet dhcp

## lan
iface eth0 inet static
  address 192.168.0.12
  netmask 255.255.255.0
  dns-nameservers 192.168.0.12 208.67.220.220 8.8.8.8

## fix openntpd to listen for lan requests on lan interface
## if there is no listen setting already, put the interface address into ntpd.conf:
  up if [[ -e /etc/openntpd/ntpd.conf ]] ;\
     then ( grep -v ^# /etc/openntpd/ntpd.conf | grep ^'listen on' ) 2>&1 > /dev/null || \
     sed -i "s/^#listen on ::1/#listen on ::1\nlisten on $IF_ADDRESS/" /etc/openntpd/ntpd.conf ;\
     fi


## modify dnsmasq.conf in several ways
  up if [[ -e /etc/dnsmasq.conf ]] ;\
     then function dm_modify { \
     appendstring="$1" ; dnsmasqlinestart="$2" ; insertionpointstring="$3" ;\
     ( grep -v ^# /etc/dnsmasq.conf | grep ^"$dnsmasqlinestart" ) 2>&1 > /dev/null || \
     sed -i "s/^\($insertionpointstring$\)/\1\n\n$dnsmasqlinestart$appendstring\n/" /etc/dnsmasq.conf ;\
     } ;\
     dm_modify "$IFACE" "interface=" '#interface=' ;\
     dm_modify "$IF_ADDRESS" "dhcp-option=option:router," '#dhcp-option=option:router,1.2.3.4' ;\
     dm_modify `echo $IF_DNS_NAMESERVERS | tr " " ","` 'dhcp-option=option:dns-server,' '#dhcp-option=option:domain-search,eng.apple.com,marketing.apple.com' ;\
     if [[ -e /etc/openntpd/ntpd.conf ]] ;\
       then ntp_listen_address=`grep -v ^# /etc/openntpd/ntpd.conf | grep ^'listen on' | tail -1 | grep -o '[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}'` ;\
       dm_modify "$ntp_listen_address" 'dhcp-option=option:ntp-server,' '#dhcp-option=option:ntp-server,192.168.0.4,10.10.0.5' ;\
     fi ;\
     fi

## dm_modify 1: set the interface so dnsmasq only serves lan
##   if there is no interface setting already, use the interface name
## dm_modify 2: set the gateway router that dnsmasq suggests for lan machines 
##   if there is no router setting already, use the interface address
## dm_modify 3: set the dns that dnsmasq suggests for lan machines
##   if there is no dns-server setting already, put the interface dns-servers into dnsmasq.conf:
## dm_modify 4: set the ntp server that dnsmasq suggests for the lan
##   if there is no ntpserver setting already in dnsmasq.conf, and if ntpd.conf exists, put the interface as an ntp suggestion option in dnsmasq:


## fix lighttpd.conf host ip address(es) to interface address, unconditionally
## match, for example: $HTTP["host"] =~ "192.168.0.12" {
## globally replace ip part with ip defined by stanza
  up if [[ -e /etc/lighttpd/lighttpd.conf ]] ;\
      then sed -i "s/^\$HTTP\[\"host\"\].*\"\([0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\)\".*$/\$HTTP[\"host\"] =~ \"$IF_ADDRESS\" {/" /etc/lighttpd/lighttpd.conf ;\
      fi



## each interface should be added allow-hotplug line above
## each uplink interface will add an uplink1, uplink2, uplink2... routing table in iproute2/rt_tables
##    using 10, 20, 30... for the serial numbers means 25 uplink interfaces at most.
##    no check is done for if the serial number is already taken by another label. Should code that and put a limit too. Later.
##    rt_tables uplink removal is not done. Should it be done?


## uplink1
iface eth1 inet static
  address 192.168.11.12
  netmask 255.255.255.0
## adjust serial, uplinkname, gateway in next line for each interface you add
  up serial=10 ; uplinkname=uplink1 ; gateway=192.168.11.1 ; tablefile=/etc/iproute2/rt_tables ;\
     if ! ( grep -v ^# $tablefile | awk '{print $2}' | grep -q -x "$uplinkname" ) ;\
        then echo "$serial	$uplinkname" >> $tablefile ;\
     fi ;\
     ip route add default via $gateway dev $IFACE table $uplinkname ;\
     ip route add default via $gateway
  dns-nameservers 208.67.220.220 8.8.8.8

## ip route add default via $gateway
## sets non-table gateway of local host to above interface (to start with anyway)


## uplink2
iface eth2 inet static
  address 192.168.12.12
  netmask 255.255.255.0
## adjust serial, uplinkname, gateway in next line for each interface you add
  up serial=20 ; uplinkname=uplink2 ; gateway=192.168.12.1 ; tablefile=/etc/iproute2/rt_tables ;\
     if ! ( grep -v ^# $tablefile | awk '{print $2}' | grep -q -x "$uplinkname" ) ;\
        then echo "$serial	$uplinkname" >> $tablefile ;\
     fi ;\
     ip route add default via $gateway dev $IFACE table $uplinkname
  dns-nameservers 208.67.220.220 8.8.8.8

## uplink3 etc, same kind of pattern as uplink2
## this file is not bash. You can only append a line of bash after "up" begins a stanza line.

